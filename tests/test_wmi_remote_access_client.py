from ipaddress import IPv4Address
from pathlib import PureWindowsPath
from unittest.mock import MagicMock

import pytest
from wmi_exploiter.smb_client import ShareInfo, SMBClient
from wmi_exploiter.wmi_client import WMIClient
from wmi_exploiter.wmi_options import WMIOptions
from wmi_exploiter.wmi_remote_access_client import (
    COPY_FILE_TAGS,
    EXECUTION_TAGS,
    LOGIN_TAGS,
    SHARE_DISCOVERY_TAGS,
    WMIRemoteAccessClient,
)
from tests.propagation_credentials import FULL_CREDENTIALS

from common import OperatingSystem
from infection_monkey.exploit.tools import (
    RemoteAuthenticationError,
    RemoteCommandExecutionError,
    RemoteFileCopyError,
)
from infection_monkey.i_puppet import TargetHost

DESTINATION_PATH = PureWindowsPath("C:\\destination_path\\agent.exe")
EXPLOITER_TAGS = {"wmi-exploiter", "unit-test"}
FILE = b"file content"
SHARED_RESOURECES = (
    ShareInfo("share1", PureWindowsPath("C:\\path1"), current_uses=10, max_uses=1000),
    ShareInfo("share2", PureWindowsPath("C:\\path2"), current_uses=100, max_uses=100),
    ShareInfo("share3", PureWindowsPath("C:\\"), current_uses=0, max_uses=10),
    ShareInfo("share4", PureWindowsPath("invalid_path"), current_uses=50, max_uses=100),
)
TARGET_HOST = TargetHost(ip=IPv4Address("1.1.1.1"), operating_system=OperatingSystem.WINDOWS)


def stub_command_builder(*args, **kwargs):
    return "command"


@pytest.fixture
def mock_smb_client():
    client = MagicMock(spec=SMBClient)
    client.connected.return_value = False

    def set_connected(value: bool):
        client.connected.return_value = value

    client.connect_with_user.side_effect = lambda *_, **__: set_connected(True)
    return client


@pytest.fixture
def mock_wmi_client():
    client = MagicMock(spec=WMIClient)
    client.connected.return_value = False

    def set_connected(value: bool):
        client.connected.return_value = value

    client.login.side_effect = lambda *_, **__: set_connected(True)
    return client


@pytest.fixture
def wmi_remote_access_client(mock_smb_client, mock_wmi_client) -> WMIRemoteAccessClient:
    return WMIRemoteAccessClient(
        TARGET_HOST, WMIOptions(), stub_command_builder, mock_smb_client, mock_wmi_client
    )


def test_login__succeeds(
    wmi_remote_access_client: WMIRemoteAccessClient,
):
    tags = EXPLOITER_TAGS.copy()

    wmi_remote_access_client.login(FULL_CREDENTIALS[0], tags)

    assert tags == EXPLOITER_TAGS.union(LOGIN_TAGS)


def test_login__fails_due_to_smb(
    mock_smb_client: SMBClient,
    wmi_remote_access_client: WMIRemoteAccessClient,
):
    tags = EXPLOITER_TAGS.copy()
    mock_smb_client.connect_with_user.side_effect = Exception()

    with pytest.raises(RemoteAuthenticationError):
        wmi_remote_access_client.login(FULL_CREDENTIALS[0], tags)

    assert tags == EXPLOITER_TAGS.union(LOGIN_TAGS)


def test_login__fails_due_to_wmi(
    mock_wmi_client: WMIClient,
    wmi_remote_access_client: WMIRemoteAccessClient,
):
    tags = EXPLOITER_TAGS.copy()
    mock_wmi_client.login.side_effect = Exception()

    with pytest.raises(RemoteAuthenticationError):
        wmi_remote_access_client.login(FULL_CREDENTIALS[0], tags)

    assert tags == EXPLOITER_TAGS.union(LOGIN_TAGS)


def test_execute__fails_if_not_authenticated(
    wmi_remote_access_client: WMIRemoteAccessClient,
):
    tags = EXPLOITER_TAGS.copy()

    with pytest.raises(RemoteCommandExecutionError):
        wmi_remote_access_client.execute_agent(DESTINATION_PATH, tags)

    assert tags == EXPLOITER_TAGS


def test_execute__fails_if_command_not_executed(
    mock_wmi_client: WMIClient,
    wmi_remote_access_client: WMIRemoteAccessClient,
):
    tags = EXPLOITER_TAGS.copy()
    mock_wmi_client.execute_remote_process.side_effect = Exception("file")
    wmi_remote_access_client.login(FULL_CREDENTIALS[0], set())

    with pytest.raises(RemoteCommandExecutionError):
        wmi_remote_access_client.execute_agent(DESTINATION_PATH, tags)

    assert tags == EXPLOITER_TAGS.union(EXECUTION_TAGS)


def test_execute__succeeds(
    wmi_remote_access_client: WMIRemoteAccessClient,
):
    tags = EXPLOITER_TAGS.copy()

    wmi_remote_access_client.login(FULL_CREDENTIALS[0], set())
    wmi_remote_access_client.execute_agent(DESTINATION_PATH, tags)

    assert tags == EXPLOITER_TAGS.union(EXECUTION_TAGS)


def test_copy_file__fails_if_not_authenticated(
    mock_smb_client: SMBClient,
    wmi_remote_access_client: WMIRemoteAccessClient,
):
    tags = EXPLOITER_TAGS.copy()
    mock_smb_client.connected.return_value = False

    with pytest.raises(RemoteFileCopyError):
        wmi_remote_access_client.copy_file(FILE, DESTINATION_PATH, tags)

    assert tags == EXPLOITER_TAGS


def test_copy_file__fails_if_no_shares_found(
    mock_smb_client: SMBClient,
    wmi_remote_access_client: WMIRemoteAccessClient,
):
    tags = EXPLOITER_TAGS.copy()
    mock_smb_client.query_shared_resources.return_value = ()
    wmi_remote_access_client.login(FULL_CREDENTIALS[0], set())

    with pytest.raises(RemoteFileCopyError):
        wmi_remote_access_client.copy_file(FILE, DESTINATION_PATH, tags)

    assert tags == EXPLOITER_TAGS.union(SHARE_DISCOVERY_TAGS)


def test_copy_file__fails_if_unable_to_connect_to_share(
    mock_smb_client: SMBClient,
    wmi_remote_access_client: WMIRemoteAccessClient,
):
    tags = EXPLOITER_TAGS.copy()
    mock_smb_client.query_shared_resources.return_value = SHARED_RESOURECES
    mock_smb_client.connect_to_share.side_effect = Exception("failed")
    wmi_remote_access_client.login(FULL_CREDENTIALS[0], set())

    with pytest.raises(RemoteFileCopyError):
        wmi_remote_access_client.copy_file(FILE, DESTINATION_PATH, tags)

    assert tags == EXPLOITER_TAGS.union(SHARE_DISCOVERY_TAGS)


def test_copy_file__fails_if_unable_to_send_file(
    mock_smb_client: SMBClient,
    wmi_remote_access_client: WMIRemoteAccessClient,
):
    tags = EXPLOITER_TAGS.copy()
    mock_smb_client.query_shared_resources.return_value = SHARED_RESOURECES
    mock_smb_client.send_file.side_effect = Exception("file")
    wmi_remote_access_client.login(FULL_CREDENTIALS[0], set())

    with pytest.raises(RemoteFileCopyError):
        wmi_remote_access_client.copy_file(FILE, DESTINATION_PATH, tags)

    assert tags == EXPLOITER_TAGS.union(SHARE_DISCOVERY_TAGS, COPY_FILE_TAGS)


def test_get_writable_paths(
    mock_smb_client: SMBClient, wmi_remote_access_client: WMIRemoteAccessClient
):
    mock_smb_client.query_shared_resources.return_value = SHARED_RESOURECES
    writable_paths = wmi_remote_access_client.get_writable_paths()

    assert len(writable_paths) == 2
    assert SHARED_RESOURECES[0].path in writable_paths
    assert SHARED_RESOURECES[2].path in writable_paths
